---
title: "Passeriformes diversification"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article aims to...

First of all, to run the analysis within this vignette we'll need to load the `treesliceR`, `ape` and `ggplot2` packages.
```{r setup}

libs <- c("ape", "devtools", "ggplot2")
if (!requireNamespace(libs, quietly = TRUE)){
    install.packages(libs)
  }
library(ape)
library(ggplot2)

libs <- c("treesliceR")
if (!requireNamespace(libs, quietly = TRUE)){
    devtools::install_github("AraujoMat/treesliceR")
  }
#devtools::install_github("AraujoMat/treesliceR") # If it isn't installed within your PC
library(treesliceR)
```

# Case study using a single passeriformes tree

## First framework example

Herein, we'll compare the passeriformes Diversification Rates (DR) before and after Australia aridification (~33 Mya). Primarily, we need to load the passeriformes phylogeny that are available within the package. The passeriformes phylogeny was obtained from [Jetz et al. (2012)](https://www.nature.com/articles/nature11631).
```{r}
devtools::load_all() # [REMOVE AFTER COMMITING]
tree <- pass_trees[[1]]
```

Now, we need to split the phylogeny into two distinct portions, one representing the last 33 millions of years ago and another the cladogenesis events before this period. To capture the root slice before 33 My, we can slice our phylogeny tipwardly (i.e., from tips to root) using the `squeeze_tips()` function. Alternatively, the tip slice of the last 33 My can be obtained through the `squeeze_root()` function, which slice a phylogeny rootwardly (i.e, from root to tips).

Since tip diversification rates (DR) calculation are dependent on the node path to a given tip, we will used the argument `dropNodes = TRUE` to remove those void nodes that could bias our estimation.
:
```{r}
recent <- squeeze_root(tree = tree, time = 33, dropNodes = T)
old <- squeeze_tips(tree = tree, time = 33, dropNodes = T)
```

We can visualize our outputted to see if our algorithm worked
```{r}
par(mfrow = c(1, 3))
plot(tree, main = "Complete tree", show.tip.label = F); axisPhylo()
plot(recent, main = "Recent tree", show.tip.label = F); axisPhylo()
plot(old, main = "Old tree", show.tip.label = F); axisPhylo()
par(mfrow = c(1, 1)) # Returning to a simple 1x1 viewer
```

Then, we need to calculate the tip diversification rates (DR) separately for each phylogeny slice, while finding their difference. To calculate the DR, we can use the function `DR()` available within the `treesliceR` package:
```{r}
DR_diff <- DR(tree = recent)[,2] - DR(tree = old)[,2]
```

Now we'll pair the differences in DR by assigning their difference to a data.frame that contains our passeriformes information inside our tree object:
```{r}
tree$Species_info$DR_diff <- DR_diff
```

To calculate the mean and standard deviation difference per passeriformes family, we use the `tapply()` function to aggregate the tip-DR's by family:
```{r}
fam_DR <- tapply(tree$Species_info$DR_diff, tree$Species_info$Family, mean)
fam_DR_sd <- tapply(tree$Species_info$DR_diff, tree$Species_info$Family, sd)
```

To visualize the differences in DR among families, lets create a dataframe contaning our outputs:
```{r}
fam_df <- data.frame(Family = names(fam_DR), DR_diff = fam_DR, DR_sd = fam_DR_sd)
# Sorting based on DR value to plot
fam_df <- fam_df[order(fam_df$DR_diff),]
fam_df$Family <- factor(fam_df$Family, levels = fam_df$Family)
```

Now, we can create a graph similar to the manuscript using the package `ggplot2`:
```{r, fig.width = 7}
ggplot(fam_df, aes(x = Family, y = DR_diff,
                    ymin = DR_diff - DR_sd,
                    ymax = DR_diff + DR_sd)) +
  geom_pointrange(color = "#d90429") +
  geom_hline(yintercept = 0, linetype="dashed", color = "black") +
  coord_flip() + theme_minimal() + 
  theme(axis.title = element_text(size = 13),
        axis.text = element_text(size = 10),
        axis.line = element_line(colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  ylab(expression(paste(DR["recent"]-DR["past"]))) + xlab(NULL)
```


Pay attention that the final outputs could be sligly different from those obtained on the [Araujo et al. (in review)]() manuscript. However, in contrast to the study, this example was executed only for a single passeriformes phylogeny. A more complete assessment using all phylogenies could be executed in the sections below. 
